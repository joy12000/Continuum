# Today.tsx ìµœì†Œ ìˆ˜ì • ì§€ì‹œ (ë³µë¶™ ê°€ì´ë“œ)

1) "ì¼ê¸° ë§Œë“¤ê¸°" í´ë¦­ í•¸ë“¤ëŸ¬ì—ì„œ API í˜¸ì¶œì„ ì•„ë˜ í˜•íƒœë¡œ ë³´ì¥í•˜ì„¸ìš”.
   - URL: `/api/generate`
   - Method: POST
   - Body: `{ type: 'daily_summary', context: [{q,a}...], tomorrow }`
   - ì‘ë‹µ OKë©´ `resp.daily`ë¥¼ ì‚¬ìš©í•´ ë³¸ë¬¸ì„ ë§Œë“¤ê³  ì €ì¥í•©ë‹ˆë‹¤.
   - ì‹¤íŒ¨/ë¹„JSONì´ë©´ **ë¡œì»¬ fallback**ìœ¼ë¡œ ë…¸íŠ¸ ì €ì¥(ë²„íŠ¼ í† ìŠ¤íŠ¸ë¡œ ì•Œë ¤ì£¼ê¸°).

ìƒ˜í”Œ:

async function handleMakeDiary() {
  setMaking(true);
  try {
    const payload = {
      type: 'daily_summary',
      context: QUESTIONS.map(x => ({ q: x.q, a: answers[x.key] || '' })),
      tomorrow: answers['tomorrow'] || ''
    };
    const r = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const j = await r.json().catch(()=>null);
    const daily = j?.daily || null;

    const dateTag = '#' + new Date().toISOString().slice(0,10);
    const tags = ['#daily', dateTag];
    let title = 'ì˜¤ëŠ˜ì˜ ì¼ê¸°', summary = '', bullets = [], tomorrow = payload.tomorrow;

    if (daily) {
      title = daily.title || title;
      summary = daily.summary || '';
      bullets = Array.isArray(daily.bullets) ? daily.bullets : [];
      tomorrow = daily.tomorrow || tomorrow;
      if (Array.isArray(daily.tags)) tags.push(...daily.tags.filter(t=>t!=='#daily'));
    } else {
      // ë¡œì»¬ fallback
      summary = payload.context.map(x => `${x.q} ${x.a}`).join('\n');
    }

    const md = [
      `# ${title}`,
      '', summary, '',
      ...bullets.map(b=>`â€¢ ${b}`),
      '', `ë‚´ì¼: ${tomorrow}`
    ].join('\n');

    const id = crypto.randomUUID();
    const now = Date.now();
    await db.notes.add({ id, content: md, createdAt: now, updatedAt: now, tags });
    await (db).embeddings.put({ noteId: id, embedding: [] }).catch(()=>{}); // ì„ì‹œ
    try { await (db).day_index?.put({ date: dateTag.slice(1), noteId: id, tomorrow }); } catch {}
    toast.success('ì˜¤ëŠ˜ ì™„ë£Œ ğŸ‰');
  } catch (e) {
    toast.error('ì¼ê¸° ìƒì„± ì‹¤íŒ¨ â€” ë¡œì»¬ ì €ì¥ìœ¼ë¡œ ëŒ€ì²´í•´ì£¼ì„¸ìš”.');
  } finally {
    setMaking(false);
  }
}

2) ë²„íŠ¼ ìƒíƒœ
- ì§„í–‰ ì¤‘ì—ëŠ” `disabled` + ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ.

ë.
